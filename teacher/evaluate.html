<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluate Assignment - Assignment Evaluator</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <!-- Page Loader -->
    <div id="page-loader">
        <div class="loader-letter">
            <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                <path d="M 15,100 C 20,60 35,20 50,10 C 65,20 80,60 85,100 M 25,65 Q 50,55 75,65" />
            </svg>
        </div>
        <div class="loader-dots">
            <span></span><span></span><span></span>
        </div>
    </div>

    <div class="portal-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üë©‚Äçüè´ AES Teacher</div>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="create-assignment.html" class="nav-item">
                    <span class="nav-icon">‚ûï</span>
                    <span>Create Assignment</span>
                </a>
                <a href="submissions.html" class="nav-item active">
                    <span class="nav-icon">üì•</span>
                    <span>Submissions</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <span class="nav-icon">üë§</span>
                    <span>Profile</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navbar -->
            <nav class="navbar">
                <h2 class="navbar-title">Evaluate Submission</h2>
                <div class="navbar-right">
                    <div class="user-info">
                        <span class="user-avatar" id="navAvatar"
                            style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-blue); color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: 600;">--</span>
                        <span class="user-name" id="navUserName">Teacher</span>
                    </div>
                    <a href="../index.html" class="btn btn-sm btn-secondary">Logout</a>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <div id="evaluateLoading" class="card">
                    <div class="card-body text-center" style="padding: 2rem;">Loading submission...</div>
                </div>
                <div id="evaluateError" style="display: none;" class="alert alert-danger"></div>
                <div id="evaluateContent" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title" id="evalPageTitle">Evaluate: ‚Äî</h1>
                        <p class="page-subtitle" id="evalStudentSubtitle">Student: ‚Äî</p>
                    </div>

                    <!-- Submission Info -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
                                <div>
                                    <strong style="color: var(--text-medium);">Submitted:</strong>
                                    <p id="evalSubmitted">‚Äî</p>
                                </div>
                                <div>
                                    <strong style="color: var(--text-medium);">Deadline:</strong>
                                    <p id="evalDeadline">‚Äî</p>
                                </div>
                                <div>
                                    <strong style="color: var(--text-medium);">Status:</strong>
                                    <p id="evalStatus"><span class="badge badge-success">On Time</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Evaluation Grid -->
                    <div class="evaluation-grid">
                        <!-- Left Column - Student Answer -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Student's Submission</h3>
                            </div>
                            <div class="card-body">
                                <div id="evalSubmissionContent" class="answer-box">
                                    <p id="submissionFileLinkWrap" style="display: none;">
                                        <strong>Submitted File:</strong>
                                        <a href="#" id="submissionFileLink" target="_blank"
                                            style="color: var(--primary-blue); text-decoration: underline;">Download
                                            File</a>
                                    </p>
                                    <div id="submissionTextContent" style="margin-top: 1rem; color: var(--text-light);">
                                        (Click the link above to view/download the student's submission)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column - Evaluation Form -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Evaluation</h3>
                            </div>
                            <div class="card-body">
                                <!-- AI Detection -->
                                <div class="alert alert-success mb-3">
                                    <span>ü§ñ</span>
                                    <div>
                                        <strong>AI Detection Result:</strong> Clean (2% probability)
                                        <br>
                                        <small>This submission appears to be original work</small>
                                    </div>
                                </div>

                                <!-- Marks -->
                                <div class="form-group">
                                    <label class="form-label">Marks Obtained (out of <span
                                            id="maxMarksLabel">100</span>)</label>
                                    <input type="number" id="evalMarks" class="form-input" placeholder="Enter marks"
                                        min="0" max="100">
                                </div>

                                <!-- Auto-suggested Marks -->
                                <div class="card mb-3" style="background: var(--bg-lighter); box-shadow: none;">
                                    <div class="card-body">
                                        <p style="margin-bottom: var(--spacing-xs);"><strong>AI Suggested
                                                Marks:</strong>
                                        </p>
                                        <div id="aiSuggestedMarks"
                                            style="font-size: 1.5rem; color: var(--primary-blue); font-weight: 700;">
                                            ‚Äî/‚Äî
                                        </div>
                                        <small style="color: var(--text-medium);">
                                            Based on: Code quality, documentation, test coverage, and complexity
                                            analysis
                                        </small>
                                    </div>
                                </div>

                                <!-- Feedback -->
                                <div class="form-group">
                                    <label class="form-label">Feedback for Student</label>
                                    <textarea id="evalFeedback" class="form-textarea"
                                        placeholder="Provide detailed feedback..." rows="8"></textarea>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex gap-2">
                                    <button type="button" id="submitEvalBtn" class="btn btn-success">
                                        ‚úì Submit Evaluation
                                    </button>
                                    <a href="submissions.html" class="btn btn-secondary">
                                        Cancel
                                    </a>
                                </div>
                                <div id="evalAlert" style="display: none; margin-top: 1rem;" class="alert"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    (function () {
        var API_URL = "http://localhost:5000";
        var n = sessionStorage.getItem("userName") || sessionStorage.getItem("userId") || "Teacher";
        document.getElementById("navUserName").textContent = n;
        document.getElementById("navAvatar").textContent = (n && n.charAt(0).toUpperCase()) || "?";
        var params = new URLSearchParams(window.location.search);
        var submissionId = params.get("submission_id");

        if (!submissionId) {
            document.getElementById("evaluateLoading").style.display = "none";
            document.getElementById("evaluateError").style.display = "block";
            document.getElementById("evaluateError").textContent = "No submission selected. Go to Submissions to choose one.";
            setTimeout(function () { window.location.href = "submissions.html"; }, 2000);
            return;
        }

        function formatDate(str) {
            if (!str) return "‚Äî";
            try { var d = new Date(str); return isNaN(d.getTime()) ? str : d.toLocaleString("en-IN", { dateStyle: "medium", timeStyle: "short" }); } catch (_) { return str; }
        }

        // Load submission data
        fetch(API_URL + "/submission/" + submissionId)
            .then(function (r) { return r.json(); })
            .then(function (data) {
                document.getElementById("evaluateLoading").style.display = "none";
                if (!data.success || !data.submission) {
                    document.getElementById("evaluateError").style.display = "block";
                    document.getElementById("evaluateError").textContent = data.message || "Submission not found.";
                    return;
                }
                var s = data.submission;
                document.getElementById("evalPageTitle").textContent = "Evaluate: " + (s.assignment_title || "Assignment");
                document.getElementById("evalStudentSubtitle").textContent = "Student: " + (s.student_name || s.student_id) + " (" + (s.student_id || "") + ")";
                document.getElementById("evalSubmitted").textContent = formatDate(s.submitted_at);
                document.getElementById("evalDeadline").textContent = formatDate(s.deadline);

                if (s.file_url) {
                    var link = document.getElementById("submissionFileLink");
                    link.textContent = "üìé View/Download Submission";
                    link.href = s.file_url;
                    link.setAttribute("target", "_blank");
                    document.getElementById("submissionFileLinkWrap").style.display = "block";
                }

                if (s.max_marks) {
                    document.getElementById("maxMarksLabel").textContent = s.max_marks;
                    document.getElementById("evalMarks").max = s.max_marks;
                    // Proportional AI suggested marks for demo (e.g. 92% of max)
                    var suggested = Math.round(s.max_marks * 0.92);
                    document.getElementById("aiSuggestedMarks").textContent = suggested + "/" + s.max_marks;
                }

                document.getElementById("evaluateContent").style.display = "block";
                hideLoader();
            })
            .catch(function () {
                document.getElementById("evaluateLoading").style.display = "none";
                document.getElementById("evaluateError").style.display = "block";
                document.getElementById("evaluateError").textContent = "Cannot connect to server.";
                hideLoader();
            });

        // Handle evaluation submission
        var submitBtn = document.getElementById("submitEvalBtn");
        var alertEl = document.getElementById("evalAlert");

        if (submitBtn) {
            submitBtn.onclick = function () {
                var marks = document.getElementById("evalMarks").value;
                var feedback = document.getElementById("evalFeedback").value;

                if (!marks) {
                    alertEl.textContent = "Please enter marks.";
                    alertEl.className = "alert alert-danger";
                    alertEl.style.display = "block";
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = "Submitting...";
                alertEl.style.display = "none";

                fetch(API_URL + "/teacher/submission/" + submissionId + "/evaluate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ marks: marks, feedback: feedback })
                })
                    .then(function (r) { return r.json(); })
                    .then(function (data) {
                        if (data.success) {
                            alertEl.textContent = "Evaluation submitted successfully!";
                            alertEl.className = "alert alert-success";
                            alertEl.style.display = "block";
                            setTimeout(function () {
                                window.location.href = "submissions.html";
                            }, 1500);
                        } else {
                            submitBtn.disabled = false;
                            submitBtn.textContent = "‚úì Submit Evaluation";
                            alertEl.textContent = data.message || "Failed to submit evaluation.";
                            alertEl.className = "alert alert-danger";
                            alertEl.style.display = "block";
                        }
                    })
                    .catch(function () {
                        submitBtn.disabled = false;
                        submitBtn.textContent = "‚úì Submit Evaluation";
                        alertEl.textContent = "Cannot connect to server.";
                        alertEl.className = "alert alert-danger";
                        alertEl.style.display = "block";
                    });
            };
        }
    })();
</script>
<script>function hideLoader() { var l = document.getElementById('page-loader'); if (l) l.classList.add('hide'); }</script>
</body>

</html>