<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submissions - Assignment Evaluator</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <!-- Page Loader -->
    <div id="page-loader">
        <div class="loader-letter">
            <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                <path d="M 15,100 C 20,60 35,20 50,10 C 65,20 80,60 85,100 M 25,65 Q 50,55 75,65" />
            </svg>
        </div>
        <div class="loader-dots">
            <span></span><span></span><span></span>
        </div>
    </div>

    <div class="portal-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üë©‚Äçüè´ AES Teacher</div>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="create-assignment.html" class="nav-item">
                    <span class="nav-icon">‚ûï</span>
                    <span>Create Assignment</span>
                </a>
                <a href="submissions.html" class="nav-item active">
                    <span class="nav-icon">üì•</span>
                    <span>Submissions</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <span class="nav-icon">üë§</span>
                    <span>Profile</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navbar -->
            <nav class="navbar">
                <h2 class="navbar-title">Submissions</h2>
                <div class="navbar-right">
                    <div class="user-info">
                        <span class="user-avatar" id="navAvatar"
                            style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-blue); color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: 600;">--</span>
                        <span class="user-name" id="navUserName">Teacher</span>
                    </div>
                    <a href="../index.html" class="btn btn-sm btn-secondary">Logout</a>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <div class="page-header">
                    <h1 class="page-title">Student Submissions</h1>
                    <p class="page-subtitle">Review and evaluate student submissions</p>
                </div>

                <div id="submissionsLoading" class="loading-container">
                    <div style="width: 80%; max-width: 800px;">
                        <div class="skeleton-box shimmer" style="height: 40px; width: 40%; margin-bottom: 2rem;"></div>
                        <div class="skeleton-box shimmer" style="height: 300px;"></div>
                    </div>
                </div>
                <div id="submissionsError" style="display: none;" class="alert alert-danger"></div>
                <!-- Filter Section (populated by JS) -->
                <div id="filterCard" class="card mb-3" style="display: none;">
                    <div class="card-body">
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Filter by Assignment</label>
                                <select class="form-select" id="filterAssignment">
                                    <option value="">All Assignments</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Filter by Status</label>
                                <select class="form-select" id="filterStatus">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="evaluated">Evaluated</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submissions Table (populated by JS) -->
                <div id="submissionsTableWrap" class="table-container" style="display: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Student Name</th>
                                <th>Assignment</th>
                                <th>Submission Time</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="submissionsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    (function () {
        var API_URL = "http://localhost:5000";
        var teacherId = sessionStorage.getItem("userId");
        var n = sessionStorage.getItem("userName") || teacherId || "Teacher";
        document.getElementById("navUserName").textContent = n;
        document.getElementById("navAvatar").textContent = (n && n.charAt(0).toUpperCase()) || "?";
        if (!teacherId) {
            document.getElementById("submissionsLoading").style.display = "none";
            document.getElementById("submissionsError").style.display = "block";
            document.getElementById("submissionsError").textContent = "Not logged in. Redirecting...";
            setTimeout(function () { window.location.href = "../login.html"; }, 1500);
            return;
        }
        function formatDate(str) {
            if (!str) return "‚Äî";
            try { var d = new Date(str); return isNaN(d.getTime()) ? str : d.toLocaleString("en-IN", { dateStyle: "short", timeStyle: "short" }); } catch (_) { return str; }
        }
        function statusBadge(status) {
            if (!status) return '<span class="badge badge-warning">Pending</span>';
            if (String(status).toLowerCase().indexOf("evaluated") !== -1) return '<span class="badge badge-info">Evaluated</span>';
            return '<span class="badge badge-warning">Pending</span>';
        }
        function renderTable(list) {
            var tbody = document.getElementById("submissionsTableBody");
            tbody.innerHTML = "";
            list.forEach(function (s) {
                var isEval = s.status && String(s.status).toLowerCase().indexOf("evaluated") !== -1;
                var action = isEval
                    ? '<button type="button" class="btn btn-sm btn-secondary">View</button>'
                    : '<a href="evaluate.html?submission_id=' + (s.submission_id || s.id) + '&assignment_id=' + (s.assignment_id || "") + '" class="btn btn-sm btn-primary">Evaluate</a>';
                tbody.insertAdjacentHTML("beforeend",
                    "<tr><td>" + (s.student_id || "‚Äî") + "</td><td>" + (s.student_name || s.student_id || "‚Äî") + "</td><td>" + (s.assignment_title || "‚Äî") + "</td><td>" + formatDate(s.submitted_at) + "</td><td>" + statusBadge(s.status) + "</td><td>" + action + "</td></tr>");
            });
            if (list.length === 0) tbody.insertAdjacentHTML("beforeend", "<tr><td colspan=\"6\" class=\"text-center\">No submissions yet.</td></tr>");
        }
        fetch(API_URL + "/teacher/" + encodeURIComponent(teacherId) + "/submissions")
            .then(function (r) { return r.json(); })
            .then(function (data) {
                document.getElementById("submissionsLoading").style.display = "none";
                document.getElementById("filterCard").style.display = "block";
                document.getElementById("submissionsTableWrap").style.display = "block";
                if (!data.success) {
                    document.getElementById("submissionsError").style.display = "block";
                    document.getElementById("submissionsError").textContent = data.message || "Failed to load.";
                    renderTable([]);
                    return;
                }
                var list = data.submissions || [];
                var assignments = data.assignments || [];
                var select = document.getElementById("filterAssignment");
                select.innerHTML = "<option value=\"\">All Assignments</option>";
                assignments.forEach(function (a) { select.insertAdjacentHTML("beforeend", "<option value=\"" + (a.id || "") + "\">" + (a.title || "‚Äî") + "</option>"); });
                renderTable(list);
                function filterList() {
                    var assignId = document.getElementById("filterAssignment").value;
                    var statusVal = document.getElementById("filterStatus").value;
                    var filtered = list.filter(function (s) {
                        if (assignId && String(s.assignment_id) !== String(assignId)) return false;
                        if (statusVal === "pending" && (!s.status || String(s.status).toLowerCase().indexOf("evaluated") !== -1)) return false;
                        if (statusVal === "evaluated" && (!s.status || String(s.status).toLowerCase().indexOf("evaluated") === -1)) return false;
                        return true;
                    });
                    renderTable(filtered);
                }
                document.getElementById("filterAssignment").addEventListener("change", filterList);
                document.getElementById("filterStatus").addEventListener("change", filterList);
                hideLoader();
            })
            .catch(function () {
                document.getElementById("submissionsLoading").style.display = "none";
                document.getElementById("submissionsError").style.display = "block";
                document.getElementById("submissionsError").textContent = "Cannot connect to server.";
                document.getElementById("filterCard").style.display = "block";
                document.getElementById("submissionsTableWrap").style.display = "block";
                renderTable([]);
                hideLoader();
            });
    })();
</script>
<script>function hideLoader() { var l = document.getElementById('page-loader'); if (l) l.classList.add('hide'); }</script>

</html>