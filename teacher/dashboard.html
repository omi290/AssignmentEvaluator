<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Assignment Evaluator</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <!-- Page Loader -->
    <div id="page-loader">
        <div class="loader-letter">
            <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                <path d="M 15,100 C 20,60 35,20 50,10 C 65,20 80,60 85,100 M 25,65 Q 50,55 75,65" />
            </svg>
        </div>
        <div class="loader-dots">
            <span></span><span></span><span></span>
        </div>
    </div>

    <div class="portal-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üë©‚Äçüè´ AES Teacher</div>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item active">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="create-assignment.html" class="nav-item">
                    <span class="nav-icon">‚ûï</span>
                    <span>Create Assignment</span>
                </a>
                <a href="submissions.html" class="nav-item">
                    <span class="nav-icon">üì•</span>
                    <span>Submissions</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <span class="nav-icon">üë§</span>
                    <span>Profile</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navbar -->
            <nav class="navbar">
                <h2 class="navbar-title">Dashboard</h2>
                <div class="navbar-right">
                    <div class="user-info">
                        <span class="user-avatar" id="navAvatar"
                            style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-blue); color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: 600;">--</span>
                        <span class="user-name" id="navUserName">Loading...</span>
                        <span class="user-id" id="navTeacherId"
                            style="font-size: 0.85rem; color: var(--text-medium); margin-left: 4px;"></span>
                    </div>
                    <a href="../index.html" class="btn btn-sm btn-secondary">Logout</a>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <div class="page-header">
                    <h1 class="page-title" id="welcomeTitle">Welcome back! üëã</h1>
                    <p class="page-subtitle">Here's your teaching overview</p>
                </div>

                <div id="dashboardLoading" class="loading-container">
                    <div style="width: 80%; max-width: 600px;">
                        <div class="skeleton-box shimmer" style="height: 40px; width: 60%; margin-bottom: 2rem;"></div>
                        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 2rem;">
                            <div class="skeleton-box shimmer" style="height: 100px;"></div>
                            <div class="skeleton-box shimmer" style="height: 100px;"></div>
                            <div class="skeleton-box shimmer" style="height: 100px;"></div>
                            <div class="skeleton-box shimmer" style="height: 100px;"></div>
                        </div>
                        <div class="skeleton-box shimmer" style="height: 200px;"></div>
                    </div>
                </div>
                <div id="dashboardError" style="display: none;" class="alert alert-danger"></div>

                <!-- Stats Grid: hidden until loaded -->
                <div id="statsGrid" class="stats-grid" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-label">Total Assignments</div>
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-change">Active this semester</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Submissions Received</div>
                        <div class="stat-value" id="statSubmissions">0</div>
                        <div class="stat-change">All time</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Pending Evaluation</div>
                        <div class="stat-value" id="statPending">0</div>
                        <div class="stat-change">Needs attention</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Evaluated</div>
                        <div class="stat-value" id="statEvaluated">0</div>
                        <div class="stat-change">Graded</div>
                    </div>
                </div>

                <!-- Recent Submissions: hidden until loaded -->
                <div id="submissionsCard" class="card" style="display: none;">
                    <div class="card-header flex-between">
                        <h3 class="card-title">Recent Submissions</h3>
                        <a href="submissions.html" class="btn btn-sm btn-primary">View All</a>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Assignment</th>
                                    <th>Submitted</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="submissionsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- My Assignments: hidden until loaded -->
                <div id="assignmentsCard" class="card mt-4" style="display: none;">
                    <div class="card-header flex-between">
                        <h3 class="card-title">My Assignments</h3>
                        <a href="create-assignment.html" class="btn btn-sm btn-primary">Create New</a>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Assignment Title</th>
                                    <th>Subject</th>
                                    <th>Deadline</th>
                                    <th>Max Marks</th>
                                    <th>Management</th>
                                </tr>
                            </thead>
                            <tbody id="assignmentsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div class="card-body">
                        <div class="flex gap-2">
                            <a href="create-assignment.html" class="btn btn-primary">
                                ‚ûï Create New Assignment
                            </a>
                            <a href="submissions.html" class="btn btn-secondary">
                                üì• View All Submissions
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Assignment Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Edit Assignment</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" id="editTitle" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subject *</label>
                        <select id="editSubject" class="form-select" required>
                            <option value="cs">Computer Science</option>
                            <option value="it">Information Technology</option>
                            <option value="ai">Artificial Intelligence</option>
                            <option value="is">Information Security</option>
                            <option value="ds">Data Science</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="editDescription" class="form-textarea" rows="4"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Deadline Date *</label>
                            <input type="date" id="editDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Deadline Time *</label>
                            <input type="time" id="editTime" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Marks *</label>
                        <input type="number" id="editMaxMarks" class="form-input" required min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Replace Question Paper (Optional)</label>
                        <input type="file" id="editFile" class="form-input" accept=".pdf,.doc,.docx">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:5000";
        const teacherId = sessionStorage.getItem("userId");
        const storedName = sessionStorage.getItem("userName");

        function setNavUser(name, id) {
            const n = name || storedName || id || "Teacher";
            document.getElementById("navUserName").textContent = n;
            document.getElementById("navTeacherId").textContent = id ? `(${id})` : "";
            const avatar = document.getElementById("navAvatar");
            avatar.textContent = n.charAt(0).toUpperCase() + (n.split(" ")[1]?.charAt(0) || "").toUpperCase() || "?";
            if (avatar.textContent.length === 1) avatar.textContent = n.charAt(0).toUpperCase();
        }

        function setWelcome(name) {
            document.getElementById("welcomeTitle").textContent = "Welcome back, " + (name || "Teacher") + "! üëã";
        }

        function timeAgo(str) {
            if (!str) return "‚Äî";
            try {
                const d = new Date(str);
                const sec = Math.floor((Date.now() - d.getTime()) / 1000);
                if (sec < 60) return "Just now";
                if (sec < 3600) return Math.floor(sec / 60) + " min ago";
                if (sec < 86400) return Math.floor(sec / 3600) + " hours ago";
                if (sec < 604800) return Math.floor(sec / 86400) + " days ago";
                return d.toLocaleDateString();
            } catch (_) { return str; }
        }

        function statusBadge(status) {
            if (!status) return '<span class="badge badge-warning">Pending</span>';
            if (status.toString().toLowerCase().includes("evaluated")) return '<span class="badge badge-info">Evaluated</span>';
            return '<span class="badge badge-warning">Pending</span>';
        }

        async function loadDashboard() {
            const loadingEl = document.getElementById("dashboardLoading");
            const errorEl = document.getElementById("dashboardError");
            const statsEl = document.getElementById("statsGrid");
            const cardEl = document.getElementById("submissionsCard");

            if (!teacherId) {
                errorEl.style.display = "block";
                errorEl.textContent = "Not logged in. Redirecting to login...";
                loadingEl.style.display = "none";
                showZerosAndEmptyTable();
                setTimeout(() => { window.location.href = "../login.html"; }, 1500);
                return;
            }

            setNavUser(storedName, teacherId);
            setWelcome(storedName);

            function showZerosAndEmptyTable() {
                document.getElementById("statTotal").textContent = 0;
                document.getElementById("statSubmissions").textContent = 0;
                document.getElementById("statPending").textContent = 0;
                document.getElementById("statEvaluated").textContent = 0;
                var tbody = document.getElementById("submissionsTableBody");
                tbody.innerHTML = "<tr><td colspan=\"5\" class=\"text-center\">No submissions yet.</td></tr>";
            }

            try {
                const [infoRes, dashRes] = await Promise.all([
                    fetch(`${API_URL}/teacher/${encodeURIComponent(teacherId)}/info`),
                    fetch(`${API_URL}/teacher/${encodeURIComponent(teacherId)}/dashboard`),
                ]);

                const info = await infoRes.json();
                const dash = await dashRes.json();

                if (info.success && info.name) {
                    setNavUser(info.name, info.teacher_id);
                    setWelcome(info.name);
                }

                document.getElementById("statTotal").textContent = (dash.success && dash.total_assignments != null) ? dash.total_assignments : 0;
                document.getElementById("statSubmissions").textContent = (dash.success && dash.submissions_received != null) ? dash.submissions_received : 0;
                document.getElementById("statPending").textContent = (dash.success && dash.pending_evaluation != null) ? dash.pending_evaluation : 0;
                document.getElementById("statEvaluated").textContent = (dash.success && dash.evaluated_count != null) ? dash.evaluated_count : 0;

                const tbody = document.getElementById("submissionsTableBody");
                tbody.innerHTML = "";
                const list = (dash.success && dash.recent_submissions) ? dash.recent_submissions : [];
                list.forEach(function (s) {
                    const isEval = s.status && s.status.toString().toLowerCase().includes("evaluated");
                    const action = isEval
                        ? '<button class="btn btn-sm btn-secondary">View</button>'
                        : '<a href="evaluate.html?submission_id=' + (s.submission_id || "") + '&assignment_id=' + (s.assignment_id || "") + '" class="btn btn-sm btn-primary">Evaluate</a>';
                    const row = "<tr><td>" + (s.student_name || s.student_id) + " (" + (s.student_id || "") + ")</td><td>" + (s.assignment_title || "‚Äî") + "</td><td>" + timeAgo(s.submitted_at) + "</td><td>" + statusBadge(s.status) + "</td><td>" + action + "</td></tr>";
                    tbody.insertAdjacentHTML("beforeend", row);
                });
                if (list.length === 0) tbody.innerHTML = "<tr><td colspan=\"5\" class=\"text-center\">No submissions yet.</td></tr>";

                // Populate Assignments
                const abody = document.getElementById("assignmentsTableBody");
                abody.innerHTML = "";
                const alist = (dash.success && dash.assignments) ? dash.assignments : [];
                window._allAssignments = alist; // Store globally for editing
                alist.forEach(function (a) {
                    const row = `
                        <tr>
                            <td>${a.title}</td>
                            <td>${(a.subject || '').toUpperCase()}</td>
                            <td>${formatDate(a.deadline)}</td>
                            <td>${a.max_marks}</td>
                            <td>
                                <div class="action-dropdown">
                                    <button class="action-btn" onclick="toggleDropdown('${a.assignment_id}')">‚ãÆ</button>
                                    <div id="dropdown-${a.assignment_id}" class="dropdown-menu">
                                        <button class="dropdown-item" onclick="prepareEdit('${a.assignment_id}')">‚úèÔ∏è Edit</button>
                                        <button class="dropdown-item danger" onclick="confirmDelete('${a.assignment_id}')">üóëÔ∏è Delete</button>
                                    </div>
                                </div>
                            </td>
                        </tr>`;
                    abody.insertAdjacentHTML("beforeend", row);
                });
                if (alist.length === 0) abody.innerHTML = "<tr><td colspan=\"5\" class=\"text-center\">No assignments created yet.</td></tr>";

                if (!dashRes.ok || !dash.success) {
                    errorEl.style.display = "block";
                    errorEl.textContent = dash.message || "Failed to load dashboard.";
                } else {
                    statsEl.style.display = "grid";
                    cardEl.style.display = "block";
                    document.getElementById("assignmentsCard").style.display = "block";
                }
                loadingEl.style.display = "none";
                hideLoader();
            } catch (err) {
                showZerosAndEmptyTable();
                errorEl.style.display = "block";
                errorEl.textContent = "Cannot connect to server. Make sure the backend is running on port 5000.";
                loadingEl.style.display = "none";
                hideLoader();
            }
        }

        function formatDate(str) {
            if (!str) return "‚Äî";
            try {
                var d = new Date(str);
                return isNaN(d.getTime()) ? str : d.toLocaleDateString("en-IN", { day: "numeric", month: "short", year: "numeric" });
            } catch (_) { return str; }
        }

        function toggleDropdown(id) {
            event.stopPropagation();
            const el = document.getElementById(`dropdown-${id}`);
            const isShow = el.classList.contains('show');
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            if (!isShow) el.classList.add('show');
        }

        window.onclick = function (event) {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        }

        function prepareEdit(id) {
            const a = window._allAssignments.find(item => item.assignment_id == id);
            if (!a) return;
            document.getElementById('editId').value = a.assignment_id;
            document.getElementById('editTitle').value = a.title;
            document.getElementById('editSubject').value = (a.subject || "").toLowerCase();
            document.getElementById('editDescription').value = a.description || "";
            document.getElementById('editMaxMarks').value = a.max_marks || 100;

            if (a.deadline) {
                const d = new Date(a.deadline);
                document.getElementById('editDate').value = d.toISOString().split('T')[0];
                document.getElementById('editTime').value = d.toTimeString().split(' ')[0].substring(0, 5);
            }
            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        document.getElementById('saveEditBtn').onclick = async function () {
            const id = document.getElementById('editId').value;
            const btn = this;
            btn.disabled = true;
            btn.textContent = "Saving...";

            const formData = new FormData();
            formData.append("title", document.getElementById("editTitle").value);
            formData.append("subject", document.getElementById("editSubject").value);
            formData.append("description", document.getElementById("editDescription").value);
            formData.append("max_marks", document.getElementById("editMaxMarks").value);
            formData.append("deadline", document.getElementById("editDate").value + " " + document.getElementById("editTime").value);

            const fileInput = document.getElementById("editFile");
            if (fileInput.files.length > 0) {
                formData.append("file", fileInput.files[0]);
            }

            try {
                const res = await fetch(`${API_URL}/teacher/${teacherId}/assignment/${id}`, {
                    method: 'PUT',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    alert("Assignment updated successfully!");
                    closeEditModal();
                    loadDashboard();
                } else {
                    alert("Update failed: " + data.message);
                }
            } catch (err) {
                alert("Error connecting to server.");
            } finally {
                btn.disabled = false;
                btn.textContent = "Save Changes";
            }
        };

        async function confirmDelete(id) {
            if (!confirm("Are you sure you want to delete this assignment? All associated submissions will also be deleted.")) return;

            try {
                const res = await fetch(`${API_URL}/teacher/${teacherId}/assignment/${id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.success) {
                    alert("Assignment deleted successfully.");
                    loadDashboard();
                } else {
                    alert("Deletion failed: " + data.message);
                }
            } catch (err) {
                alert("Error connecting to server.");
            }
        }

        document.addEventListener("DOMContentLoaded", loadDashboard);
    </script>
    <script>function hideLoader() { var l = document.getElementById('page-loader'); if (l) l.classList.add('hide'); }</script>
</body>

</html>