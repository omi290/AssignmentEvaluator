<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results - Assignment Evaluator</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="portal-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üìö AES Student</div>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="assignments.html" class="nav-item">
                    <span class="nav-icon">üìù</span>
                    <span>Assignments</span>
                </a>
                <a href="results.html" class="nav-item active">
                    <span class="nav-icon">üéØ</span>
                    <span>Results</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <span class="nav-icon">üë§</span>
                    <span>Profile</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navbar -->
            <nav class="navbar">
                <h2 class="navbar-title">Results</h2>
                <div class="navbar-right">
                    <div class="user-info">
                        <span class="user-avatar" id="navAvatar" style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-blue); color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: 600;">--</span>
                        <span class="user-name" id="navUserName">Student</span>
                    </div>
                    <a href="../index.html" class="btn btn-sm btn-secondary">Logout</a>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <div class="page-header">
                    <h1 class="page-title">Assignment Results</h1>
                    <p class="page-subtitle">View your grades and feedback</p>
                </div>

                <div id="resultsLoading" class="card"><div class="card-body text-center" style="padding: 2rem;">Loading results...</div></div>
                <div id="resultsError" style="display: none;" class="alert alert-danger"></div>
                <div id="resultsTableWrap" class="table-container mb-4" style="display: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Assignment</th>
                                <th>Subject</th>
                                <th>Submitted Date</th>
                                <th>Marks</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>

                <!-- Detailed Result Card (populated when a result is selected or first item) -->
                <div id="detailCard" class="card" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title" id="detailTitle">‚Äî</h3>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid mb-3" id="detailStats"></div>
                        <div id="detailFeedback" style="display: none;">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-dark);">Teacher's Feedback</h4>
                            <div class="answer-box" id="detailFeedbackText"></div>
                        </div>
                        <div class="mt-3">
                            <a href="assignments.html" class="btn btn-secondary">Back to Assignments</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
(function(){
    var API_URL = "http://localhost:5000";
    var studentId = sessionStorage.getItem("userId");
    var n = sessionStorage.getItem("userName") || studentId || "Student";
    document.getElementById("navUserName").textContent = n;
    document.getElementById("navAvatar").textContent = (n && n.charAt(0).toUpperCase()) || "?";
    if (!studentId) {
        document.getElementById("resultsLoading").style.display = "none";
        document.getElementById("resultsError").style.display = "block";
        document.getElementById("resultsError").textContent = "Not logged in. Redirecting...";
        setTimeout(function(){ window.location.href = "../login.html"; }, 1500);
        return;
    }
    function formatDate(str) {
        if (!str) return "‚Äî";
        try { var d = new Date(str); return isNaN(d.getTime()) ? str : d.toLocaleDateString("en-IN", { day: "numeric", month: "short", year: "numeric" }); } catch (_) { return str; }
    }
    function renderDetail(result) {
        if (!result) return;
        document.getElementById("detailTitle").textContent = result.assignment_title || "‚Äî";
        var marks = result.marks != null ? result.marks : result.score;
        var marksStr = marks != null ? (marks + "/100") : "‚Äî";
        document.getElementById("detailStats").innerHTML =
            "<div class=\"stat-card success\"><div class=\"stat-label\">Score</div><div class=\"stat-value\">" + marksStr + "</div><div class=\"stat-change\">Evaluated</div></div>" +
            "<div class=\"stat-card\"><div class=\"stat-label\">Submitted</div><div class=\"stat-value\">" + formatDate(result.submitted_at) + "</div><div class=\"stat-change\">On Time</div></div>";
        var fb = result.feedback;
        if (fb) {
            document.getElementById("detailFeedbackText").textContent = fb;
            document.getElementById("detailFeedback").style.display = "block";
        } else document.getElementById("detailFeedback").style.display = "none";
        document.getElementById("detailCard").style.display = "block";
    }
    fetch(API_URL + "/student/" + encodeURIComponent(studentId) + "/results")
        .then(function(r){ return r.json(); })
        .then(function(data){
            document.getElementById("resultsLoading").style.display = "none";
            if (!data.success) {
                document.getElementById("resultsError").style.display = "block";
                document.getElementById("resultsError").textContent = data.message || "Failed to load.";
                return;
            }
            var list = data.results || [];
            var tbody = document.getElementById("resultsTableBody");
            tbody.innerHTML = "";
            list.forEach(function(res, idx){
                var marks = res.marks != null ? res.marks : res.score;
                var marksStr = marks != null ? ("<strong style=\"color: var(--success);\">" + marks + "/100</strong>") : "‚Äî";
                tbody.insertAdjacentHTML("beforeend",
                    "<tr><td>" + (res.assignment_title || "‚Äî") + "</td><td>" + (res.subject || "‚Äî") + "</td><td>" + formatDate(res.submitted_at) + "</td><td>" + marksStr + "</td><td><button type=\"button\" class=\"btn btn-sm btn-primary\" data-idx=\"" + idx + "\">View Details</button></td></tr>");
            });
            document.getElementById("resultsTableWrap").style.display = "block";
            if (list.length === 0) {
                tbody.insertAdjacentHTML("beforeend", "<tr><td colspan=\"5\" class=\"text-center\">No evaluated results yet.</td></tr>");
            } else {
                renderDetail(list[0]);
                tbody.querySelectorAll("button[data-idx]").forEach(function(btn){
                    btn.addEventListener("click", function(){ renderDetail(list[parseInt(btn.getAttribute("data-idx"), 10)]); });
                });
            }
        })
        .catch(function(){
            document.getElementById("resultsLoading").style.display = "none";
            document.getElementById("resultsError").style.display = "block";
            document.getElementById("resultsError").textContent = "Cannot connect to server. Is the backend running on port 5000?";
        });
})();
</script>
</html>