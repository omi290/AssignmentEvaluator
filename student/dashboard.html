<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Assignment Evaluator</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <!-- Page Loader -->
    <div id="page-loader">
        <div class="loader-letter">
            <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                <path d="M 15,100 C 20,60 35,20 50,10 C 65,20 80,60 85,100 M 25,65 Q 50,55 75,65" />
            </svg>
        </div>
        <div class="loader-dots">
            <span></span><span></span><span></span>
        </div>
    </div>

    <div class="portal-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üìö AES Student</div>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item active">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="assignments.html" class="nav-item">
                    <span class="nav-icon">üìù</span>
                    <span>Assignments</span>
                </a>
                <a href="results.html" class="nav-item">
                    <span class="nav-icon">üéØ</span>
                    <span>Results</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <span class="nav-icon">üë§</span>
                    <span>Profile</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navbar -->
            <nav class="navbar">
                <h2 class="navbar-title">Dashboard</h2>
                <div class="navbar-right">
                    <div class="user-info">
                        <span class="user-avatar" id="navAvatar"
                            style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-blue); color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: 600;">--</span>
                        <span class="user-name" id="navUserName">Loading...</span>
                        <span class="user-id" id="navStudentId"
                            style="font-size: 0.85rem; color: var(--text-medium); margin-left: 4px;"></span>
                    </div>
                    <a href="../index.html" class="btn btn-sm btn-secondary">Logout</a>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <div class="page-header">
                    <h1 class="page-title" id="welcomeTitle">Welcome back! üëã</h1>
                    <p class="page-subtitle">Here's your assignment overview</p>
                </div>

                <!-- Loading state -->
                <div id="dashboardLoading" class="loading-container">
                    <div style="width: 80%; max-width: 600px;">
                        <div class="skeleton-box shimmer" style="height: 40px; width: 60%; margin-bottom: 2rem;"></div>
                        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 2rem;">
                            <div class="skeleton-box shimmer" style="height: 100px;"></div>
                            <div class="skeleton-box shimmer" style="height: 100px;"></div>
                            <div class="skeleton-box shimmer" style="height: 100px;"></div>
                            <div class="skeleton-box shimmer" style="height: 100px;"></div>
                        </div>
                        <div class="skeleton-box shimmer" style="height: 200px;"></div>
                    </div>
                </div>
                <div id="dashboardError" style="display: none;" class="alert alert-danger"></div>

                <!-- Stats Grid: hidden until loaded -->
                <div id="statsGrid" class="stats-grid" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-label">Total Assignments</div>
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-change">From your courses</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Pending</div>
                        <div class="stat-value" id="statPending">0</div>
                        <div class="stat-change">Due soon</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Submitted</div>
                        <div class="stat-value" id="statSubmitted">0</div>
                        <div class="stat-change">On time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Evaluated</div>
                        <div class="stat-value" id="statEvaluated">0</div>
                        <div class="stat-change">Graded</div>
                    </div>
                </div>

                <!-- Recent Assignments: hidden until loaded -->
                <div id="assignmentsCard" class="card" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Recent Assignments</h3>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Assignment</th>
                                    <th>Subject</th>
                                    <th>Deadline</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="assignmentsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:5000";
        const studentId = sessionStorage.getItem("userId");
        const storedName = sessionStorage.getItem("userName");

        function setNavUser(name, id) {
            const n = name || storedName || id || "Student";
            document.getElementById("navUserName").textContent = n;
            document.getElementById("navStudentId").textContent = id ? `(${id})` : "";
            const avatar = document.getElementById("navAvatar");
            avatar.textContent = n.charAt(0).toUpperCase() + (n.split(" ")[1]?.charAt(0) || "").toUpperCase() || "?";
            if (avatar.textContent.length === 1) avatar.textContent = n.charAt(0).toUpperCase();
        }

        function setWelcome(name) {
            document.getElementById("welcomeTitle").textContent = "Welcome back, " + (name || "Student") + "! üëã";
        }

        function statusBadge(status) {
            if (!status) return '<span class="badge badge-warning">Pending</span>';
            if (status.toString().toLowerCase().includes("evaluated")) return '<span class="badge badge-info">Evaluated</span>';
            if (status.toString().toLowerCase().includes("submitted")) return '<span class="badge badge-success">Submitted</span>';
            return '<span class="badge badge-warning">Pending</span>';
        }

        function formatDate(str) {
            if (!str) return "‚Äî";
            try {
                const d = new Date(str);
                return isNaN(d.getTime()) ? str : d.toLocaleDateString("en-IN", { day: "numeric", month: "short", year: "numeric" });
            } catch (_) { return str; }
        }

        async function loadDashboard() {
            const loadingEl = document.getElementById("dashboardLoading");
            const errorEl = document.getElementById("dashboardError");
            const statsEl = document.getElementById("statsGrid");
            const cardEl = document.getElementById("assignmentsCard");

            if (!studentId) {
                errorEl.style.display = "block";
                errorEl.textContent = "Not logged in. Redirecting to login...";
                loadingEl.style.display = "none";
                showZerosAndEmptyTable();
                setTimeout(() => { window.location.href = "../login.html"; }, 1500);
                return;
            }

            setNavUser(storedName, studentId);
            setWelcome(storedName);

            function showZerosAndEmptyTable() {
                document.getElementById("statTotal").textContent = 0;
                document.getElementById("statPending").textContent = 0;
                document.getElementById("statSubmitted").textContent = 0;
                document.getElementById("statEvaluated").textContent = 0;
                var tbody = document.getElementById("assignmentsTableBody");
                tbody.innerHTML = "<tr><td colspan=\"5\" class=\"text-center\">No assignments yet.</td></tr>";
            }

            try {
                const [infoRes, dashRes] = await Promise.all([
                    fetch(`${API_URL}/student/${encodeURIComponent(studentId)}/info`),
                    fetch(`${API_URL}/student/${encodeURIComponent(studentId)}/dashboard`),
                ]);

                const info = await infoRes.json();
                const dash = await dashRes.json();

                if (info.success && info.name) {
                    setNavUser(info.name, info.student_id);
                    setWelcome(info.name);
                }

                document.getElementById("statTotal").textContent = (dash.success && dash.total_assignments != null) ? dash.total_assignments : 0;
                document.getElementById("statPending").textContent = (dash.success && dash.pending_count != null) ? dash.pending_count : 0;
                document.getElementById("statSubmitted").textContent = (dash.success && dash.submitted_count != null) ? dash.submitted_count : 0;
                document.getElementById("statEvaluated").textContent = (dash.success && dash.evaluated_count != null) ? dash.evaluated_count : 0;

                const tbody = document.getElementById("assignmentsTableBody");
                tbody.innerHTML = "";
                const list = (dash.success && dash.assignments) ? dash.assignments : [];
                list.forEach(function (a) {
                    const status = a.submission_status;
                    const isEval = status && status.toString().toLowerCase().includes("evaluated");
                    const isSub = status && (status.toString().toLowerCase().includes("submitted") || status.toString().toLowerCase().includes("evaluated"));
                    const action = isEval
                        ? '<a href="results.html?assignment_id=' + (a.id || "") + '" class="btn btn-sm btn-secondary">Results</a>'
                        : isSub
                            ? '<a href="results.html?assignment_id=' + (a.id || "") + '" class="btn btn-sm btn-secondary">View</a>'
                            : '<a href="submission.html?assignment_id=' + (a.id || "") + '" class="btn btn-sm btn-primary">Submit</a>';
                    const row = "<tr><td>" + (a.title || "‚Äî") + "</td><td>" + (a.subject || "‚Äî") + "</td><td>" + formatDate(a.deadline) + "</td><td>" + statusBadge(status) + "</td><td>" + action + "</td></tr>";
                    tbody.insertAdjacentHTML("beforeend", row);
                });
                if (list.length === 0) tbody.innerHTML = "<tr><td colspan=\"5\" class=\"text-center\">No assignments yet.</td></tr>";

                if (!dashRes.ok || !dash.success) {
                    errorEl.style.display = "block";
                    errorEl.textContent = dash.message || "Failed to load dashboard.";
                } else {
                    statsEl.style.display = "grid";
                    cardEl.style.display = "block";
                }
                loadingEl.style.display = "none";
                hideLoader();
            } catch (err) {
                showZerosAndEmptyTable();
                errorEl.style.display = "block";
                errorEl.textContent = "Cannot connect to server. Make sure the backend is running on port 5000.";
                loadingEl.style.display = "none";
                hideLoader();
            }
        }

        document.addEventListener("DOMContentLoaded", loadDashboard);
    </script>
    <script>function hideLoader() { var l = document.getElementById('page-loader'); if (l) l.classList.add('hide'); }</script>
</body>

</html>