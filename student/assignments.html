<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignments - Assignment Evaluator</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="portal-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üìö AES Student</div>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="assignments.html" class="nav-item active">
                    <span class="nav-icon">üìù</span>
                    <span>Assignments</span>
                </a>
                <a href="results.html" class="nav-item">
                    <span class="nav-icon">üéØ</span>
                    <span>Results</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <span class="nav-icon">üë§</span>
                    <span>Profile</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navbar -->
            <nav class="navbar">
                <h2 class="navbar-title">Assignments</h2>
                <div class="navbar-right">
                    <div class="user-info">
                        <span class="user-avatar" id="navAvatar"
                            style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-blue); color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: 600;">--</span>
                        <span class="user-name" id="navUserName">Student</span>
                    </div>
                    <a href="../index.html" class="btn btn-sm btn-secondary">Logout</a>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <div class="page-header">
                    <h1 class="page-title">All Assignments</h1>
                    <p class="page-subtitle">View and submit your assignments</p>
                </div>

                <div id="assignmentsLoading" class="loading-container">
                    <div style="width: 80%; max-width: 800px;">
                        <div class="skeleton-box shimmer" style="height: 40px; width: 40%; margin-bottom: 2rem;"></div>
                        <div class="skeleton-box shimmer" style="height: 300px;"></div>
                    </div>
                </div>
                <div id="assignmentsError" style="display: none;" class="alert alert-danger"></div>
                <!-- Assignments Table: hidden until data is loaded -->
                <div id="assignmentsTableWrap" class="table-container" style="display: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Assignment Title</th>
                                <th>Subject</th>
                                <th>Deadline</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="assignmentsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Submission Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Edit Submission</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <p>Current Submission: <a id="currentFileLink" href="#" target="_blank">View File</a></p>
                </div>
                <form id="editForm">
                    <input type="hidden" id="editSubmissionId">
                    <div class="form-group">
                        <label class="form-label">Upload New File *</label>
                        <input type="file" id="editFile" class="form-input" accept=".pdf,.doc,.docx" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" id="saveEditBtn">Replace Submission</button>
            </div>
        </div>
    </div>
</body>
<script>
    (function () {
        var API_URL = "http://localhost:5000";
        var studentId = sessionStorage.getItem("userId");
        var n = sessionStorage.getItem("userName") || studentId || "Student";
        document.getElementById("navUserName").textContent = n;
        document.getElementById("navAvatar").textContent = (n && n.charAt(0).toUpperCase()) || "?";
        if (!studentId) {
            document.getElementById("assignmentsLoading").style.display = "none";
            document.getElementById("assignmentsError").style.display = "block";
            document.getElementById("assignmentsError").textContent = "Not logged in. Redirecting...";
            setTimeout(function () { window.location.href = "../login.html"; }, 1500);
            return;
        }
        function statusBadge(status) {
            if (!status) return '<span class="badge badge-warning">Pending</span>';
            if (String(status).toLowerCase().indexOf("evaluated") !== -1) return '<span class="badge badge-info">Evaluated</span>';
            if (String(status).toLowerCase().indexOf("submitted") !== -1) return '<span class="badge badge-success">Submitted</span>';
            return '<span class="badge badge-warning">Pending</span>';
        }
        function formatDate(str) {
            if (!str) return "‚Äî";
            try {
                var d = new Date(str);
                return isNaN(d.getTime()) ? str : d.toLocaleDateString("en-IN", { day: "numeric", month: "short", year: "numeric" });
            } catch (_) { return str; }
        }
        function renderTable(list) {
            var tbody = document.getElementById("assignmentsTableBody");
            tbody.innerHTML = "";
            window._allAssignments = list;
            list.forEach(function (a) {
                var status = a.submission_status;
                var isEval = status && String(status).toLowerCase().indexOf("evaluated") !== -1;
                var isSub = status && String(status).toLowerCase().indexOf("submitted") !== -1;

                var action = "";
                if (isEval) {
                    action = '<a href="results.html?assignment_id=' + (a.id || "") + '" class="btn btn-sm btn-secondary">Results</a>';
                } else if (isSub) {
                    action = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <a href="results.html?assignment_id=${a.id || ""}" class="btn btn-sm btn-secondary">View</a>
                            <div class="action-dropdown">
                                <button class="action-btn" onclick="toggleDropdown('${a.submission_id}')">‚ãÆ</button>
                                <div id="dropdown-${a.submission_id}" class="dropdown-menu">
                                    <button class="dropdown-item" onclick="prepareEdit('${a.submission_id}')">‚úèÔ∏è Edit</button>
                                    <button class="dropdown-item danger" onclick="confirmDelete('${a.submission_id}')">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        </div>`;
                } else {
                    action = '<a href="submission.html?assignment_id=' + (a.id || "") + '" class="btn btn-sm btn-primary">Submit</a>';
                }

                tbody.insertAdjacentHTML("beforeend",
                    "<tr><td>" + (a.title || "‚Äî") + "</td><td>" + (a.subject || "‚Äî") + "</td><td>" + formatDate(a.deadline) + "</td><td>" + statusBadge(status) + "</td><td>" + action + "</td></tr>");
            });
            if (list.length === 0) tbody.insertAdjacentHTML("beforeend", "<tr><td colspan=\"5\" class=\"text-center\">No assignments yet.</td></tr>");
        }

        function toggleDropdown(id) {
            if (event) event.stopPropagation();
            const el = document.getElementById(`dropdown-${id}`);
            const isShow = el.classList.contains('show');
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            if (!isShow) el.classList.add('show');
        }

        window.onclick = function (event) {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        }

        function prepareEdit(id) {
            const a = window._allAssignments.find(item => item.submission_id == id);
            if (!a) return;
            document.getElementById('editSubmissionId').value = a.submission_id;
            document.getElementById('currentFileLink').href = a.file_url;
            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        document.getElementById('saveEditBtn').onclick = async function () {
            const id = document.getElementById('editSubmissionId').value;
            const fileInput = document.getElementById("editFile");
            if (fileInput.files.length === 0) {
                alert("Please select a file.");
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.textContent = "Updating...";

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            try {
                const res = await fetch(`${API_URL}/student/${studentId}/submission/${id}`, {
                    method: 'PUT',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    alert("Submission updated successfully!");
                    window.location.reload();
                } else {
                    alert("Update failed: " + data.message);
                }
            } catch (err) {
                alert("Error connecting to server.");
            } finally {
                btn.disabled = false;
                btn.textContent = "Replace Submission";
            }
        };

        async function confirmDelete(id) {
            if (!confirm("Are you sure you want to delete your submission?")) return;

            try {
                const res = await fetch(`${API_URL}/student/${studentId}/submission/${id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.success) {
                    alert("Submission deleted.");
                    window.location.reload();
                } else {
                    alert("Deletion failed: " + data.message);
                }
            } catch (err) {
                alert("Error connecting to server.");
            }
        }
        fetch(API_URL + "/student/" + encodeURIComponent(studentId) + "/assignments")
            .then(function (r) { return r.json(); })
            .then(function (data) {
                document.getElementById("assignmentsLoading").style.display = "none";
                if (!data.success) {
                    document.getElementById("assignmentsError").style.display = "block";
                    document.getElementById("assignmentsError").textContent = data.message || "Failed to load.";
                    renderTable([]);
                    return;
                }
                document.getElementById("assignmentsTableWrap").style.display = "block";
                renderTable(data.assignments || []);
            })
            .catch(function () {
                document.getElementById("assignmentsLoading").style.display = "none";
                document.getElementById("assignmentsError").style.display = "block";
                document.getElementById("assignmentsError").textContent = "Cannot connect to server. Is the backend running on port 5000?";
                renderTable([]);
            });
    })();
</script>

</html>